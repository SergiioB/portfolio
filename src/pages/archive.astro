---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { CATEGORY_META } from '../content/categories';
import { SITE } from '../config/site';
import { withBase } from '../utils/paths';
import PostSearch from '../components/PostSearch.astro';

const posts = await getCollection('posts');
const sortedPosts = posts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = post.data.pubDate.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
---

<BaseLayout title={`Archive | ${SITE.author}`} description="Chronological archive of technical case studies.">
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <a href={withBase()}>Home</a>
    <span>/</span>
    <span>Archive</span>
  </nav>

  <header class="page-header page-header-tight">
    <p class="eyebrow">Archive</p>
    <h1>All Case Studies</h1>
    <p class="page-description">
      {sortedPosts.length} post{sortedPosts.length === 1 ? '' : 's'} grouped by year, each with clear issue and solution framing.
    </p>
  </header>

  <PostSearch
    itemSelector="[data-search-item]"
    sectionSelector=".archive-year"
    placeholder="Search all posts (title, issue, solution, tags)..."
  />

  <div class="archive-content">
    {years.map((year) => (
      <section class="archive-year" aria-labelledby={`year-heading-${year}`} id={`year-${year}`}>
        <h2 id={`year-heading-${year}`} class="archive-year-header">{year}</h2>
        <div class="archive-posts">
          {postsByYear[year].map((post) => (
            <article
              class="archive-post panel panel-soft"
              data-search-item
              data-search={`${post.data.title} ${post.data.description} ${post.data.issue ?? ''} ${post.data.solution ?? ''} ${post.data.usedIn ?? ''} ${(post.data.tags ?? []).join(' ')} ${post.data.category}`}
            >
              <time class="archive-post-date" datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </time>

              <div>
                <a href={withBase(`posts/${post.id}/`)} class="archive-post-title">
                  {post.data.title}
                </a>
                <p class="archive-post-summary">
                  <strong>Issue:</strong> {post.data.issue ?? post.data.description}
                </p>
                {post.data.solution && (
                  <p class="archive-post-summary">
                    <strong>Solution:</strong> {post.data.solution}
                  </p>
                )}
              </div>

              <span class={`category-badge archive-post-badge ${post.data.category}`}>
                {CATEGORY_META[post.data.category].label}
              </span>
            </article>
          ))}
        </div>
      </section>
    ))}

    {years.length === 0 && <p class="empty-state panel panel-soft">No posts published yet.</p>}
  </div>
</BaseLayout>
