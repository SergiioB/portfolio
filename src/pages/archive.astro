---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import { CATEGORY_META } from '../content/categories';
import { SITE } from '../config/site';
import { withBase } from '../utils/paths';

const posts = await getCollection('posts');
const sortedPosts = posts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = post.data.pubDate.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

const years = Object.keys(postsByYear).map(Number).sort((a, b) => b - a);
---

<BaseLayout title={`Archive | ${SITE.author}`} description="Browse all published notes grouped by year.">
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <a href={withBase()}>Home</a>
    <span>/</span>
    <span>Archive</span>
  </nav>

  <header class="page-header page-header-tight">
    <p class="eyebrow">Archive</p>
    <h1>All published notes</h1>
    <p class="page-description">
      {sortedPosts.length} post{sortedPosts.length === 1 ? '' : 's'} across {years.length} year{years.length === 1 ? '' : 's'}.
    </p>
  </header>

  <div class="archive-content">
    {years.map((year) => (
      <section class="archive-year" aria-labelledby={`year-${year}`}>
        <h2 id={`year-${year}`} class="archive-year-header">{year}</h2>
        <div class="archive-posts">
          {postsByYear[year].map((post) => (
            <div class="archive-post panel panel-soft">
              <time class="archive-post-date" datetime={post.data.pubDate.toISOString()}>
                {post.data.pubDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
              </time>
              <a href={withBase(`posts/${post.id}/`)} class="archive-post-title">
                {post.data.title}
              </a>
              <span class={`category-badge archive-post-badge ${post.data.category}`}>
                {CATEGORY_META[post.data.category].label}
              </span>
            </div>
          ))}
        </div>
      </section>
    ))}

    {years.length === 0 && <p class="empty-state panel panel-soft">No posts published yet.</p>}
  </div>
</BaseLayout>
