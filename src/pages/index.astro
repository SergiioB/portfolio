---
import { getCollection } from 'astro:content';
import PostCard from '../components/PostCard.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { CATEGORY_META, CATEGORY_ORDER } from '../content/categories';
import { PUBLIC_CV, SITE } from '../config/site';
import { withBase } from '../utils/paths';

const posts = await getCollection('posts');
const publishedPosts = posts
  .filter((post) => !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const latestPosts = publishedPosts.slice(0, 8);
const categoryCounts = CATEGORY_ORDER.map((category) => ({
  slug: category,
  label: CATEGORY_META[category].label,
  description: CATEGORY_META[category].description,
  count: publishedPosts.filter((post) => post.data.category === category).length,
}));

const activeCategories = categoryCounts.filter((category) => category.count > 0);
const latestDate = publishedPosts[0]?.data.pubDate;
const publicCvHref = PUBLIC_CV.external ? PUBLIC_CV.href : withBase(PUBLIC_CV.href);
---

<BaseLayout title={`${SITE.author} | Infrastructure Engineering Notes`} description={SITE.description}>
  <section class="hero panel" aria-labelledby="home-hero-title">
    <div class="hero-kicker">Infrastructure portfolio</div>
    <h1 id="home-hero-title" class="hero-title">
      Practical infrastructure notes with clear, reusable patterns.
    </h1>
    <p class="hero-description">
      Operations, automation, cloud, and local AI work documented as concise implementation-first posts.
    </p>

    <div class="hero-actions">
      <a href={withBase('about/')} class="action-link action-link-secondary">About me</a>
      <a href={withBase('archive/')} class="action-link action-link-secondary">Archive</a>
      {PUBLIC_CV.enabled && (
        <a
          href={publicCvHref}
          class="action-link"
          target={PUBLIC_CV.openInNewTab ? '_blank' : undefined}
          rel={PUBLIC_CV.openInNewTab ? 'noopener noreferrer' : undefined}
        >
          {PUBLIC_CV.label}
        </a>
      )}
    </div>

    <div class="hero-grid">
      <div class="panel panel-soft stat-card">
        <div class="stat-label">Published posts</div>
        <div class="stat-value">{publishedPosts.length}</div>
        <div class="stat-meta">Markdown-based engineering notes</div>
      </div>
      <div class="panel panel-soft stat-card">
        <div class="stat-label">Active domains</div>
        <div class="stat-value">{activeCategories.length}</div>
        <div class="stat-meta">Clear topic split by category</div>
      </div>
      <div class="panel panel-soft stat-card">
        <div class="stat-label">Latest update</div>
        <div class="stat-value stat-value-sm">
          {latestDate
            ? latestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
            : 'No posts yet'}
        </div>
        <div class="stat-meta">Always visible from post dates</div>
      </div>
    </div>
  </section>

  <section class="section-block panel panel-soft section-surface" aria-labelledby="intent-title">
    <div class="section-header-row">
      <h2 id="intent-title">Focus</h2>
      <a href={withBase('about/')} class="subtle-link">Profile</a>
    </div>
    <div class="signal-grid">
      <article class="panel panel-soft signal-card">
        <h3>Execution over claims</h3>
        <p>Posts are organized by delivery domain and centered on real implementation notes.</p>
      </article>
      <article class="panel panel-soft signal-card">
        <h3>Simple publishing</h3>
        <p>Astro + Markdown keeps maintenance low and writing flow fast.</p>
      </article>
      <article class="panel panel-soft signal-card">
        <h3>Public-safe by default</h3>
        <p>Content stays technical while avoiding private or employer-sensitive details.</p>
      </article>
    </div>
  </section>

  <section class="section-block panel panel-soft section-surface" aria-labelledby="domains-title">
    <div class="section-header-row">
      <h2 id="domains-title">Categories</h2>
      <a href={withBase('archive/')} class="subtle-link">Browse all</a>
    </div>
    <div class="category-grid">
      {categoryCounts.map((category) => (
        <a href={withBase(`${category.slug}/`)} class={`category-tile panel panel-soft category-${category.slug}`}>
          <div class="category-tile-top">
            <span class={`category-badge ${category.slug}`}>{category.label}</span>
            <span class="category-tile-count">{category.count}</span>
          </div>
          <p>{category.description}</p>
        </a>
      ))}
    </div>
  </section>

  <section class="section-block panel panel-soft section-surface" aria-labelledby="latest-posts-title">
    <div class="section-header-row">
      <h2 id="latest-posts-title">Recent posts</h2>
      <a href={withBase('archive/')} class="subtle-link">All posts</a>
    </div>

    <div class="post-feed" aria-label="Latest posts">
      {latestPosts.map((post) => (
        <PostCard post={post} />
      ))}

      {publishedPosts.length === 0 && <p class="empty-state panel panel-soft">No posts published yet.</p>}
    </div>
  </section>
</BaseLayout>
