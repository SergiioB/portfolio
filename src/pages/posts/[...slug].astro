---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCategoryLabel } from '../../content/categories';
import { SITE } from '../../config/site';
import { withBase } from '../../utils/paths';
import { estimateReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
const { title, description, pubDate, category, tags, updatedDate } = post.data;
const readingTime = estimateReadingTime(post.body);
---

<BaseLayout title={`${title} | ${SITE.author}`} description={description}>
  <a href={withBase()} class="back-link">← Back to posts</a>

  <article class="article-shell">
    <header class="article-header">
      <nav class="breadcrumbs" aria-label="Breadcrumb">
        <a href={withBase()}>Home</a>
        <span>/</span>
        <a href={withBase(`${category}/`)}>{getCategoryLabel(category)}</a>
      </nav>

      <div class="article-meta">
        <time datetime={pubDate.toISOString()}>
          {pubDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
          })}
        </time>
        <span aria-hidden="true">•</span>
        <span>{readingTime} min read</span>
        {updatedDate && (
          <>
            <span aria-hidden="true">•</span>
            <span>Updated {updatedDate.toLocaleDateString('en-US')}</span>
          </>
        )}
      </div>

      <h1 class="article-title">{title}</h1>
      <p class="page-description">{description}</p>

      {tags && tags.length > 0 && (
        <div class="post-tags post-tags-spaced" aria-label="Post tags">
          {tags.map((tag) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      )}
    </header>

    <div class="article-content prose-shell">
      <Content />
    </div>

    <footer class="article-footer">
      <a href={withBase('archive/')} class="back-link">← Browse archive</a>
    </footer>
  </article>
</BaseLayout>
